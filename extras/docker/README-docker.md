# Unum and Docker

The files in this folder are used to build and start a Docker container
complete with everything necessary to run as a Linux router, including the
Unum agent.

For the Unum agent to function, a Minim Labs developer account is required.
Sign up for an account or find out more on the [Minim Labs website][1].


### Known Limitations

As this is a work-in-progress, some things are not yet working:

 - Only supports USB wireless adapters on Linux
 - No wireless device support on macOS
 - Untested on Windows


## Building and Starting

Run the `docker_build.sh` script under `extras/linux_generic/` to build a
new image and then start a container and configure it for use.

On Linux, the script must be run as root or have access to the docker daemon.
From the unum root directory, assuming your host WAN interface is "ens33":
    sudo extras/docker/docker_build.sh ens33

Full usage:

```bash
extras/docker/docker_build.sh [-X|-B <builder>] <WAN ifname>
```

The WAN interface name (`<WAN ifname>` above) should be the host machine's
internet-connected interface. A bridge is created between the host and Unum
container and this is used as the WAN interface on the container.

Skip building an image at all by passing `-X`.

```bash
sudo extras/docker/docker_build.sh -X ens33
```

Skip building a builder image, but recreate and configure the Unum container:

```bash
sudo extras/docker/docker_build.sh \
        -B unum-builder-ubuntu:16.04 ens33
```

## Starting Unum

Once the container is running, you'll be placed into a bash session running in
the container. 

Run the `startup.sh` command to start all the required services. On the first
run, the user will be prompted to automatically configure network interfaces, 
wireless AP details if applicable, and start the services for a Linux router.

> You will need a specific, generated MAC address during first time setup. This
  MAC address is used to associate your agent with your Minim Labs account.
  Sign up and login to the [Minim Labs developer portal][1], click the top-
  right drop down, then click "Provisioning Details".

The `<generated MAC>` is generated by the Minim cloud application, and requires
a [Minim Labs developer account][1].

Start everything with `startup.sh`:

```bash
startup.sh
```

On the first run, the script will interactively configure Unum and set the
MAC address for you before starting everything.


## Technical Overview

There are two Docker images generated by the build, a "builder" and the actual
Unum-enabled Linux router image.

The "builder" image, built from `Dockerfile.build`, has all of the build-time
dependencies installed on an Ubuntu 16.04 base. When started, the container
will run the unum `build.sh` script and generate a tarball in
`/usr/local/unum/out/` (inside the container). This tarball is used in the
second stage of the process to install Unum.

The router image is built from `Dockerfile` and includes: dnsmasq, hostapd,
iptables, the Unum agent, and a host of other programs for running a Linux
router. Additionally, several shell scripts are included to manage the
configuration and startup of all the services.

 - `startup.sh` (re)starts everything, first time run will also run 
   `config_interfaces.sh`.
 - `config_interfaces.sh` will prompt the user for details to fully configure
   the system's network interfaces. This script generates files for
   `/etc/network/interfaces.d/` as well as an `extras.conf.sh` file used
   by the other scripts.
 - `start_networking.sh` configures the network interfaces
 - `start_dnsmasq.sh` generates a dnsmasq.conf file and starts dnsmasq
 - `start_hostapd.sh` generates a hostapd.conf file and starts hostapd
 - `start_routing.sh` configures iptables and enables IP forwarding
 - `start_unum.sh` starts unum as a daemon
 - `stop_all.sh` stops all the services.
 - `/opt/unum/extras/sbin/unum_env.sh` is a library script that can be sourced
   in bash sessions.

Configuration files are stored in `/etc/opt/unum`
Log files and other runtime files are stored in `/var/opt/unum`
Unum and co are installed in `/opt/unum`

[1]: https://my.minim.co/labs